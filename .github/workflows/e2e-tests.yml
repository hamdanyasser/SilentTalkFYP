name: E2E Tests

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # Create ephemeral environment
  create-environment:
    name: Create Ephemeral Environment
    runs-on: ubuntu-latest
    outputs:
      environment_id: ${{ steps.create-env.outputs.environment_id }}
      client_url: ${{ steps.create-env.outputs.client_url }}
      server_url: ${{ steps.create-env.outputs.server_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create unique environment ID
        id: create-env
        run: |
          ENV_ID="e2e-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "environment_id=$ENV_ID" >> $GITHUB_OUTPUT
          echo "client_url=http://client-$ENV_ID.localhost:3000" >> $GITHUB_OUTPUT
          echo "server_url=http://server-$ENV_ID.localhost:5000" >> $GITHUB_OUTPUT
          echo "Created environment: $ENV_ID"

  # Deploy to ephemeral environment
  deploy-ephemeral:
    name: Deploy to Ephemeral Environment
    runs-on: ubuntu-latest
    needs: create-environment

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: silenttalk_e2e
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci

      - name: Build server
        working-directory: ./server
        run: npm run build

      - name: Run database migrations
        working-directory: ./server
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/silenttalk_e2e
        run: npm run migrate || echo "No migrations configured"

      - name: Start server
        working-directory: ./server
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/silenttalk_e2e
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
          PORT: 5000
        run: |
          npm start &
          echo $! > server.pid

          # Wait for server to be ready
          for i in {1..30}; do
            if curl -f http://localhost:5000/health > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            echo "Waiting for server... ($i/30)"
            sleep 2
          done

      - name: Install client dependencies
        working-directory: ./client
        run: npm ci

      - name: Build client
        working-directory: ./client
        env:
          REACT_APP_API_URL: http://localhost:5000
        run: npm run build

      - name: Start client
        working-directory: ./client
        run: |
          npx serve -s build -l 3000 &
          echo $! > client.pid

          # Wait for client to be ready
          for i in {1..20}; do
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "Client is ready!"
              break
            fi
            echo "Waiting for client... ($i/20)"
            sleep 2
          done

      - name: Seed test data
        working-directory: ./server
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/silenttalk_e2e
        run: npm run seed:e2e || echo "No seed script configured"

      - name: Save PIDs for cleanup
        run: |
          echo "server_pid=$(cat server/server.pid)" >> $GITHUB_ENV
          echo "client_pid=$(cat client/client.pid)" >> $GITHUB_ENV

  # Run E2E tests
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    needs: [create-environment, deploy-ephemeral]
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Playwright
        run: |
          npm install -D @playwright/test
          npx playwright install --with-deps chromium firefox

      - name: Run Playwright E2E tests
        env:
          BASE_URL: ${{ needs.create-environment.outputs.client_url }}
          API_URL: ${{ needs.create-environment.outputs.server_url }}
        run: |
          # Create Playwright config if not exists
          cat > playwright.config.ts <<EOF
          import { defineConfig } from '@playwright/test';

          export default defineConfig({
            testDir: './e2e',
            timeout: 30000,
            use: {
              baseURL: process.env.BASE_URL || 'http://localhost:3000',
              screenshot: 'only-on-failure',
              video: 'retain-on-failure',
            },
            projects: [
              { name: 'chromium', use: { browserName: 'chromium' } },
              { name: 'firefox', use: { browserName: 'firefox' } },
            ],
            reporter: [
              ['html'],
              ['junit', { outputFile: 'test-results/junit.xml' }],
            ],
          });
          EOF

          # Run tests
          npx playwright test || true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: test-results/
          retention-days: 30

  # Run Cypress E2E tests (alternative)
  cypress-tests:
    name: Run Cypress E2E Tests
    runs-on: ubuntu-latest
    needs: [create-environment, deploy-ephemeral]
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd client
          npm ci
          npm install cypress@latest --save-dev

      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: ./client
          start: npm start
          wait-on: 'http://localhost:3000'
          wait-on-timeout: 120
          browser: chrome
          record: false
          config: baseUrl=http://localhost:3000

      - name: Upload Cypress screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: client/cypress/screenshots
          retention-days: 30

      - name: Upload Cypress videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos
          path: client/cypress/videos
          retention-days: 30

  # Cleanup ephemeral environment
  cleanup-environment:
    name: Cleanup Ephemeral Environment
    runs-on: ubuntu-latest
    needs: [create-environment, e2e-tests, cypress-tests]
    if: always()

    steps:
      - name: Cleanup environment
        run: |
          echo "Cleaning up environment: ${{ needs.create-environment.outputs.environment_id }}"
          # Kill processes if needed
          # Remove temporary files
          # Deallocate resources
          echo "Cleanup complete"

  # Generate E2E test report
  test-report:
    name: Generate E2E Test Report
    runs-on: ubuntu-latest
    needs: [e2e-tests, cypress-tests]
    if: always()

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Generate report
        run: |
          echo "# E2E Test Report" > report.md
          echo "" >> report.md
          echo "**Environment ID:** ${{ needs.create-environment.outputs.environment_id }}" >> report.md
          echo "**Client URL:** ${{ needs.create-environment.outputs.client_url }}" >> report.md
          echo "**Server URL:** ${{ needs.create-environment.outputs.server_url }}" >> report.md
          echo "" >> report.md
          echo "## Test Results" >> report.md
          echo "" >> report.md
          echo "| Test Suite | Status |" >> report.md
          echo "|------------|--------|" >> report.md
          echo "| Playwright | ${{ needs.e2e-tests.result == 'success' && '✅ PASS' || '❌ FAIL' }} |" >> report.md
          echo "| Cypress | ${{ needs.cypress-tests.result == 'success' && '✅ PASS' || '❌ FAIL' }} |" >> report.md

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: e2e-report
          path: report.md

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
