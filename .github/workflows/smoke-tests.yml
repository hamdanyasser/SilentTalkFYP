name: Smoke Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
  schedule:
    # Run hourly
    - cron: '0 * * * *'

env:
  NODE_VERSION: '18'

jobs:
  # K6 Smoke Tests
  k6-smoke:
    name: K6 Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: silenttalk_smoke
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci

      - name: Build server
        working-directory: ./server
        run: npm run build

      - name: Start server
        working-directory: ./server
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/silenttalk_smoke
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
          PORT: 5000
        run: |
          npm start &
          echo $! > server.pid

          # Wait for server
          for i in {1..30}; do
            if curl -f http://localhost:5000/health > /dev/null 2>&1; then
              echo "Server ready!"
              break
            fi
            sleep 2
          done

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run k6 smoke tests
        env:
          TEST_MODE: smoke
          API_BASE_URL: http://localhost:5000
        run: |
          cd performance-tests
          mkdir -p smoke-reports

          # Run API smoke test
          k6 run \
            --out json=smoke-reports/api-smoke-raw.json \
            --summary-export=smoke-reports/api-smoke-summary.json \
            api-performance.test.js

      - name: Check smoke test results
        run: |
          cd performance-tests/smoke-reports

          # Parse results
          if [ -f api-smoke-summary.json ]; then
            P95=$(cat api-smoke-summary.json | jq '.metrics.http_req_duration.values["p(95)"]')
            ERROR_RATE=$(cat api-smoke-summary.json | jq '.metrics.http_req_failed.values.rate')

            echo "API P95 Latency: ${P95}ms"
            echo "Error Rate: ${ERROR_RATE}"

            # Check thresholds
            if (( $(echo "$P95 > 500" | bc -l) )); then
              echo "‚ùå Smoke test failed: P95 latency too high"
              exit 1
            fi

            if (( $(echo "$ERROR_RATE > 0.05" | bc -l) )); then
              echo "‚ùå Smoke test failed: Error rate too high"
              exit 1
            fi

            echo "‚úÖ Smoke tests passed"
          fi

      - name: Upload smoke test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-smoke-results
          path: performance-tests/smoke-reports/
          retention-days: 7

  # Health Check Tests
  health-check:
    name: Health Check Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install and start server
        working-directory: ./server
        run: |
          npm ci
          npm run build
          npm start &
          sleep 10

      - name: Check server health
        run: |
          # Health endpoint
          RESPONSE=$(curl -s http://localhost:5000/health)
          echo "Health check response: $RESPONSE"

          STATUS=$(echo $RESPONSE | jq -r '.status')
          if [ "$STATUS" != "healthy" ]; then
            echo "‚ùå Health check failed"
            exit 1
          fi

          echo "‚úÖ Server is healthy"

      - name: Check API readiness
        run: |
          # Test critical endpoints
          curl -f http://localhost:5000/api/health || exit 1
          curl -f http://localhost:5000/health/ready || exit 1
          curl -f http://localhost:5000/health/live || exit 1

          echo "‚úÖ All health endpoints responding"

  # Frontend Smoke Tests
  frontend-smoke:
    name: Frontend Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Build client
        working-directory: ./client
        run: npm run build

      - name: Start client
        working-directory: ./client
        run: |
          npx serve -s build -l 3000 &
          sleep 5

      - name: Test frontend accessibility
        run: |
          # Check if app loads
          RESPONSE=$(curl -s http://localhost:3000)
          if [ -z "$RESPONSE" ]; then
            echo "‚ùå Frontend failed to load"
            exit 1
          fi

          echo "‚úÖ Frontend loads successfully"

      - name: Test static assets
        run: |
          # Check if static assets are accessible
          curl -f http://localhost:3000/static/css/main.*.css || echo "CSS check failed"
          curl -f http://localhost:3000/static/js/main.*.js || echo "JS check failed"

          echo "‚úÖ Static assets accessible"

  # Database Migration Smoke Test
  migration-smoke:
    name: Database Migration Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 5

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: silenttalk_migration_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: ./server
        run: npm ci

      - name: Run migrations
        working-directory: ./server
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/silenttalk_migration_test
        run: |
          npm run migrate || echo "No migrations configured"

          echo "‚úÖ Migrations completed successfully"

      - name: Test database connection
        env:
          PGPASSWORD: test
        run: |
          # Test connection
          psql -h localhost -U test -d silenttalk_migration_test -c "SELECT version();"

          echo "‚úÖ Database connection successful"

  # Smoke Test Summary
  smoke-summary:
    name: Smoke Test Summary
    runs-on: ubuntu-latest
    needs: [k6-smoke, health-check, frontend-smoke, migration-smoke]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## üîç Smoke Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| K6 Smoke Tests | ${{ needs.k6-smoke.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Checks | ${{ needs.health-check.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Smoke | ${{ needs.frontend-smoke.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Migration Smoke | ${{ needs.migration-smoke.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any smoke test failed
        if: |
          needs.k6-smoke.result != 'success' ||
          needs.health-check.result != 'success' ||
          needs.frontend-smoke.result != 'success' ||
          needs.migration-smoke.result != 'success'
        run: |
          echo "‚ùå One or more smoke tests failed"
          exit 1

      - name: Success message
        if: success()
        run: |
          echo "‚úÖ All smoke tests passed successfully!"
