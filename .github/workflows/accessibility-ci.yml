name: Accessibility CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'client/**'
      - '.github/workflows/accessibility-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'client/**'

jobs:
  accessibility-tests:
    name: Accessibility Tests (Axe + Lighthouse)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./client
        run: npx playwright install --with-deps chromium

      - name: Type check
        working-directory: ./client
        run: npm run type-check

      - name: Build application
        working-directory: ./client
        run: npm run build

      - name: Start preview server
        working-directory: ./client
        run: |
          npm run preview &
          npx wait-on http://localhost:4173 -t 30000
        env:
          VITE_APP_URL: http://localhost:4173

      - name: Run Axe accessibility tests
        working-directory: ./client
        run: npm run a11y:test
        env:
          VITE_APP_URL: http://localhost:4173
        continue-on-error: false

      - name: Run Lighthouse accessibility audit
        working-directory: ./client
        run: npm run lighthouse
        env:
          VITE_APP_URL: http://localhost:4173
        continue-on-error: true

      - name: Upload Axe report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: axe-accessibility-report
          path: client/a11y-report.json
          retention-days: 30

      - name: Upload Lighthouse report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-accessibility-report
          path: client/lighthouse-report.json
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const axeReport = JSON.parse(fs.readFileSync('client/a11y-report.json', 'utf8'));

            let comment = '## Accessibility Test Results\n\n';
            comment += `### Axe-Core Report\n\n`;
            comment += `- **Total Violations**: ${axeReport.summary.totalViolations}\n`;
            comment += `  - Critical: ${axeReport.summary.critical}\n`;
            comment += `  - Serious: ${axeReport.summary.serious}\n`;
            comment += `  - Moderate: ${axeReport.summary.moderate}\n`;
            comment += `  - Minor: ${axeReport.summary.minor}\n\n`;

            if (axeReport.summary.totalViolations === 0) {
              comment += 'âœ… **All accessibility tests passed!**\n\n';
            } else {
              comment += 'âŒ **Accessibility violations found. Please fix them.**\n\n';

              axeReport.pages.forEach(page => {
                if (page.violations && page.violations.length > 0) {
                  comment += `#### ${page.name}\n\n`;
                  page.violations.forEach(v => {
                    comment += `- [${v.impact.toUpperCase()}] **${v.id}**: ${v.help}\n`;
                  });
                  comment += '\n';
                }
              });
            }

            comment += '\nðŸ“„ Full reports available in artifacts.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  eslint-a11y:
    name: ESLint JSX A11y
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Run ESLint with a11y plugin
        working-directory: ./client
        run: npx eslint . --ext .tsx,.ts --max-warnings 0
