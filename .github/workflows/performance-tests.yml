name: Performance Tests

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'client/**'
      - 'server/**'
      - 'performance-tests/**'
      - '.github/workflows/performance-tests.yml'
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - stress
          - spike
          - all

env:
  NODE_VERSION: '18'
  K6_VERSION: 'v0.47.0'

jobs:
  setup:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if performance tests should run
        id: check
        run: |
          # Always run on main or workflow_dispatch
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          # For PRs, check if performance-critical files changed
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Check if PR has performance label or critical files changed
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'performance') }}" == "true" ]]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  api-performance:
    name: API Performance Tests
    needs: setup
    if: needs.setup.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            client/package-lock.json
            server/package-lock.json

      - name: Install dependencies
        run: |
          cd server && npm ci
          cd ../client && npm ci

      - name: Start server
        run: |
          cd server
          npm run build
          npm start &
          echo "Waiting for server to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:5000/health > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run API performance tests
        env:
          TEST_MODE: ${{ github.event.inputs.test_type || 'smoke' }}
          API_BASE_URL: http://localhost:5000
        run: |
          cd performance-tests
          mkdir -p reports
          k6 run \
            --out json=reports/api-performance-raw.json \
            --summary-export=reports/api-performance-summary.json \
            api-performance.test.js

      - name: Upload API test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-performance-results
          path: performance-tests/reports/api-performance*.json
          retention-days: 30

      - name: Check performance thresholds
        run: |
          cd performance-tests
          node ../scripts/check-performance-thresholds.js reports/api-performance-summary.json

  webrtc-load:
    name: WebRTC Load Tests
    needs: setup
    if: needs.setup.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: cd server && npm ci

      - name: Start server with WebSocket support
        run: |
          cd server
          npm run build
          npm start &
          echo "Waiting for server to be ready..."
          sleep 10

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run WebRTC load tests
        env:
          TEST_MODE: ${{ github.event.inputs.test_type || 'smoke' }}
          API_BASE_URL: http://localhost:5000
          WS_BASE_URL: ws://localhost:5000
        run: |
          cd performance-tests
          mkdir -p reports
          k6 run \
            --out json=reports/webrtc-load-raw.json \
            --summary-export=reports/webrtc-load-summary.json \
            webrtc-load.test.js

      - name: Upload WebRTC test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: webrtc-load-results
          path: performance-tests/reports/webrtc-load*.json
          retention-days: 30

  ml-inference:
    name: ML Inference Tests
    needs: setup
    if: needs.setup.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: cd server && npm ci

      - name: Start server
        run: |
          cd server
          npm run build
          npm start &
          echo "Waiting for server to be ready..."
          sleep 10

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run ML inference tests
        env:
          TEST_MODE: ${{ github.event.inputs.test_type || 'smoke' }}
          API_BASE_URL: http://localhost:5000
        run: |
          cd performance-tests
          mkdir -p reports
          k6 run \
            --out json=reports/ml-inference-raw.json \
            --summary-export=reports/ml-inference-summary.json \
            ml-inference.test.js

      - name: Upload ML test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ml-inference-results
          path: performance-tests/reports/ml-inference*.json
          retention-days: 30

  frontend-performance:
    name: Frontend Performance Tests
    needs: setup
    if: needs.setup.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        run: cd client && npm ci

      - name: Build client
        run: cd client && npm run build

      - name: Start frontend server
        run: |
          cd client
          npx serve -s build -l 3000 &
          echo "Waiting for frontend to be ready..."
          sleep 5

      - name: Install k6 with browser support
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Install Chromium for k6 browser
        run: |
          npx playwright install chromium
          npx playwright install-deps chromium

      - name: Run page load budget tests
        env:
          WEB_BASE_URL: http://localhost:3000
          SCREENSHOT: 'true'
        run: |
          cd performance-tests
          mkdir -p reports/screenshots
          k6 run \
            --out json=reports/page-load-raw.json \
            --summary-export=reports/page-load-summary.json \
            page-load-budget.test.js

      - name: Upload frontend test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-performance-results
          path: |
            performance-tests/reports/page-load*.json
            performance-tests/reports/screenshots/*.png
          retention-days: 30

  generate-report:
    name: Generate Performance Report
    needs: [api-performance, webrtc-load, ml-inference, frontend-performance]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: performance-tests/reports

      - name: Install report dependencies
        run: |
          npm install -g markdown-table json2md

      - name: Generate consolidated report
        run: |
          cd performance-tests
          node ../scripts/generate-performance-report.js

      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-tests/reports/performance-report.*
          retention-days: 90

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'performance-tests/reports/performance-report.md';

            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

      - name: Check for performance regressions
        run: |
          cd scripts
          node detect-performance-regressions.js ../performance-tests/reports

      - name: Fail if thresholds not met
        if: github.event_name == 'pull_request'
        run: |
          cd scripts
          node check-all-thresholds.js ../performance-tests/reports || exit 1

  baseline-update:
    name: Update Performance Baseline
    needs: [api-performance, webrtc-load, ml-inference, frontend-performance]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: performance-tests/reports

      - name: Update performance baseline
        run: |
          mkdir -p performance-tests/baseline
          cp -r performance-tests/reports/*.json performance-tests/baseline/
          echo "Updated baseline on $(date)" > performance-tests/baseline/LAST_UPDATE.txt

      - name: Commit baseline updates
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add performance-tests/baseline/
          git commit -m "Update performance baseline [skip ci]" || echo "No changes to commit"
          git push || echo "No changes to push"
