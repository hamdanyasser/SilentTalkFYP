name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'claude/**'
  pull_request:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '18'
  CACHE_VERSION: 'v1'

jobs:
  # Job 1: Build and Test Client
  client-build-test:
    name: Client - Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Lint
        working-directory: ./client
        run: npm run lint

      - name: Type check
        working-directory: ./client
        run: npm run type-check || npx tsc --noEmit

      - name: Run tests
        working-directory: ./client
        run: npm test -- --coverage --watchAll=false

      - name: Build
        working-directory: ./client
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: client-build
          path: client/build
          retention-days: 7

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./client/coverage/lcov.info
          flags: client
          name: client-coverage

  # Job 2: Build and Test Server
  server-build-test:
    name: Server - Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: silenttalk_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        working-directory: ./server
        run: npm ci

      - name: Lint
        working-directory: ./server
        run: npm run lint

      - name: Type check
        working-directory: ./server
        run: npm run type-check || npx tsc --noEmit

      - name: Run tests
        working-directory: ./server
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/silenttalk_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
        run: npm test -- --coverage

      - name: Build
        working-directory: ./server
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: server-build
          path: server/dist
          retention-days: 7

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./server/coverage/lcov.info
          flags: server
          name: server-coverage

  # Job 3: Code Quality Checks
  code-quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd client && npm ci
          cd ../server && npm ci

      - name: Run ESLint
        run: |
          cd client && npm run lint -- --format=json --output-file=../eslint-client.json || true
          cd ../server && npm run lint -- --format=json --output-file=../eslint-server.json || true

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Check code formatting
        run: |
          cd client && npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css}" || true
          cd ../server && npx prettier --check "src/**/*.{ts,js,json}" || true

  # Job 4: Dependency Audit
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Audit client dependencies
        working-directory: ./client
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Audit server dependencies
        working-directory: ./server
        run: npm audit --audit-level=high
        continue-on-error: true

  # Job 5: Build Success Summary
  build-success:
    name: Build Success ✓
    runs-on: ubuntu-latest
    needs: [client-build-test, server-build-test, code-quality, dependency-audit]
    if: success()

    steps:
      - name: Build Summary
        run: |
          echo "✅ All builds and tests passed successfully!"
          echo "Client: ✓"
          echo "Server: ✓"
          echo "Code Quality: ✓"
          echo "Dependencies: ✓"

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ✅ CI Pipeline Success

            All checks passed successfully:
            - ✅ Client build and tests
            - ✅ Server build and tests
            - ✅ Code quality checks
            - ✅ Dependency audit

            Ready for review!`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
